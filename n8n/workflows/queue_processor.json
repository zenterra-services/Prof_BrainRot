{
  "name": "Video Queue Processor - Personal Batch (2-3 videos)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 10
            }
          ]
        }
      },
      "id": "trigger-cron",
      "name": "Cron - Check Queue Every 10min",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1.1,
      "position": [100, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM get_next_batch(3);"
      },
      "id": "postgres-get-batch",
      "name": "PostgreSQL - Get Next Batch",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [300, 200],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "if-has-items",
      "name": "IF - Has Items to Process?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [500, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT mark_batch_processing(ARRAY[{{ $json["script_id"] }}]);"
      },
      "id": "postgres-mark-processing",
      "name": "PostgreSQL - Mark as Processing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [700, 150],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      },
      "notesInFlow": true,
      "notes": "Mark items as processing to prevent duplicate processing"
    },
    {
      "parameters": {
        "batch": {
          "batch": {
            "waitBetweenBatches": 5
          }
        },
        "options": {}
      },
      "id": "splitInBatches",
      "name": "SplitInBatches - Process 1 by 1",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 2,
      "position": [900, 150]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO api_usage_log (script_id, api_provider, api_endpoint, request_type) VALUES ('{{ $json["script_id"] }}', 'zebracat', 'https://api.zebracat.com/v1/videos', 'create') RETURNING id;"
      },
      "id": "postgres-log-api-start",
      "name": "PostgreSQL - Log API Start",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [1100, 100],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "url": "https://api.zebracat.com/v1/videos",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {},
        "bodyParameters": {
          "parameters": [
            {
              "name": "script",
              "value": "={{ $json['content'] }}"
            },
            {
              "name": "style",
              "value": "educational"
            },
            {
              "name": "duration",
              "value": "={{ $json['estimated_attention_span'] || 30 }}"
            },
            {
              "name": "platform",
              "value": "={{ $json['target_platform'] }}"
            }
          ]
        },
        "method": "POST"
      },
      "id": "httpRequest-zebracat",
      "name": "HTTP Request - Zebracat API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 100],
      "credentials": {
        "httpHeaderAuth": {
          "id": "zebracat-api-key",
          "name": "Zebracat API Key"
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.statusCode }}",
              "operation": "equal",
              "value2": 200
            }
          ]
        }
      },
      "id": "if-api-success",
      "name": "IF - API Success?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1500, 100]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE video_queue SET status = 'completed', completed_at = CURRENT_TIMESTAMP, video_url = '{{ $json.video_url }}', video_duration = {{ $json.duration }} WHERE script_id = '{{ $json.script_id }}';"
      },
      "id": "postgres-mark-completed",
      "name": "PostgreSQL - Mark Completed",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [1700, 50],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE video_queue SET status = 'failed', error_count = error_count + 1, error_message = '{{ $json.error }}' WHERE script_id = '{{ $json.script_id }}';"
      },
      "id": "postgres-mark-failed",
      "name": "PostgreSQL - Mark Failed",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [1700, 250],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO error_log (script_id, error_type, error_message, error_context) VALUES ('{{ $json.script_id }}', 'api_error', '{{ $json.error }}', '{{ $json }}');"
      },
      "id": "postgres-log-error",
      "name": "PostgreSQL - Log Error",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [1900, 250],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE api_usage_log SET status_code = {{ $json.statusCode }}, response_time = {{ $json.responseTime }}, completed_at = CURRENT_TIMESTAMP WHERE script_id = '{{ $json.script_id }}' ORDER BY id DESC LIMIT 1;"
      },
      "id": "postgres-update-api-log",
      "name": "PostgreSQL - Update API Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [1900, 50],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "channel": "email",
        "subject": "ProfBrainRot: Video Generation Failed",
        "text": "Script ID: {{ $json.script_id }}\nError: {{ $json.error }}\nPlease check the error log for details.",
        "toEmail": "{{ $env.PROCESSING_NOTIFICATION_EMAIL }}"
      },
      "id": "email-error-notification",
      "name": "Email - Error Notification",
      "type": "n8n-nodes-base.email",
      "typeVersion": 2.1,
      "position": [2100, 250],
      "credentials": {
        "smtp": {
          "id": "profbrainrot-smtp",
          "name": "ProfBrainRot SMTP"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE api_usage_log SET status_code = {{ $json.statusCode }}, error_message = '{{ $json.error }}', completed_at = CURRENT_TIMESTAMP WHERE script_id = '{{ $json.script_id }}' ORDER BY id DESC LIMIT 1;"
      },
      "id": "postgres-update-api-log-fail",
      "name": "PostgreSQL - Update API Log (Fail)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [1500, 350],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.error_count }}",
              "operation": "larger",
              "value2": 2
            }
          ]
        }
      },
      "id": "if-max-retries",
      "name": "IF - Max Retries Reached?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2100, 150]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE video_queue SET status = 'cancelled' WHERE script_id = '{{ $json.script_id }}';"
      },
      "id": "postgres-mark-cancelled",
      "name": "PostgreSQL - Mark Cancelled",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [2300, 200],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM queue_status_summary;"
      },
      "id": "postgres-get-stats",
      "name": "PostgreSQL - Get Queue Stats",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.2,
      "position": [2300, 50],
      "credentials": {
        "postgres": {
          "id": "profbrainrot-postgres",
          "name": "ProfBrainRot Postgres"
        }
      }
    },
    {
      "parameters": {
        "channel": "email",
        "subject": "ProfBrainRot: Daily Queue Summary",
        "text": "Daily Queue Summary:\n{{ $json }}\n\nQueue Status:\n{{ $node['postgres-get-stats'].json }}",
        "toEmail": "{{ $env.PROCESSING_NOTIFICATION_EMAIL }}"
      },
      "id": "email-daily-summary",
      "name": "Email - Daily Summary",
      "type": "n8n-nodes-base.email",
      "typeVersion": 2.1,
      "position": [2500, 50],
      "credentials": {
        "smtp": {
          "id": "profbrainrot-smtp",
          "name": "ProfBrainRot SMTP"
        }
      }
    }
  ],
  "connections": {
    "trigger-cron": {
      "main": [
        [
          {
            "node": "postgres-get-batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "postgres-get-batch": {
      "main": [
        [
          {
            "node": "if-has-items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-has-items": {
      "main": [
        [
          {
            "node": "postgres-mark-processing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "postgres-get-stats",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "postgres-mark-processing": {
      "main": [
        [
          {
            "node": "splitInBatches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "splitInBatches": {
      "main": [
        [
          {
            "node": "postgres-log-api-start",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "postgres-log-api-start": {
      "main": [
        [
          {
            "node": "httpRequest-zebracat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "httpRequest-zebracat": {
      "main": [
        [
          {
            "node": "if-api-success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-api-success": {
      "main": [
        [
          {
            "node": "postgres-mark-completed",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "postgres-mark-failed",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "postgres-mark-completed": {
      "main": [
        [
          {
            "node": "postgres-update-api-log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "postgres-mark-failed": {
      "main": [
        [
          {
            "node": "postgres-log-error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "postgres-log-error": {
      "main": [
        [
          {
            "node": "if-max-retries",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-max-retries": {
      "main": [
        [
          {
            "node": "postgres-mark-cancelled",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "email-error-notification",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "postgres-get-stats": {
      "main": [
        [
          {
            "node": "email-daily-summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true
  }
}